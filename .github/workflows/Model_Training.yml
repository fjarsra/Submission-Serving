name: Model Training Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# ðŸ”¥ IZIN WAJIB: Biar bot bisa upload gambar ke repo
permissions:
  contents: write

jobs:
  train-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint pandas scikit-learn mlflow xgboost requests matplotlib seaborn
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f Membangun_model/requirements.txt ]; then pip install -r Membangun_model/requirements.txt; fi

    # Cek Kode (Opsional: Matikan Warning)
    - name: Lint with pylint
      run: pylint --disable=R,C,W *.py Membangun_model/*.py || true

    # Training Biasa
    - name: Run Model Training
      run: python Membangun_model/modelling.py

    # ðŸ”¥ HYPERPARAMETER TUNING (YANG PENTING)
    # Ini akan generate 4 gambar PNG di folder Membangun_model
    - name: Run Hyperparameter Tuning
      env:
        MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
      run: python Membangun_model/modelling_tuning.py
      continue-on-error: true

    - name: Run Inference Test
      run: python inference.py
      continue-on-error: true

    # ========================================================
    # ðŸ“¸ BAGIAN BARU: PUSH GAMBAR PNG KE REPO
    # ========================================================
    - name: Commit and Push Images
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
        # Tambahkan semua file PNG yang baru dibuat di folder Membangun_model
        git add Membangun_model/*.png
        
        # Cek apakah ada perubahan, kalau ada baru di-commit
        git commit -m "ðŸ“Š Auto-update: Hyperparameter Tuning Plots [skip ci]" || echo "No changes to commit"
        
        # Push balik ke GitHub
        git push

    # Upload Artifact ZIP (Cadangan kalau mau download manual)
    - name: Upload Trained Model
      uses: actions/upload-artifact@v4
      with:
        name: trained-model-artifact
        path: Membangun_model/model
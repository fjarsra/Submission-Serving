name: CI/CD Training Pipeline (Final Offline Fix)

on:
  push:
    paths:
      - 'Workflow-CI/**'
  workflow_dispatch:

permissions:
  contents: write

env:
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
  MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
  MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
  DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/submission-mlops-model

jobs:
  train-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install mlflow dagshub pandas scikit-learn xgboost matplotlib seaborn

      # 1. Jalankan Training
      # Script ini sekarang akan membuat folder 'model_docker' secara otomatis
      - name: Run Training & Save Local Model
        run: |
          cd Workflow-CI/MLProject
          python modelling.py

      # 2. Ambil Run ID (Tetap perlu untuk nama tag atau log)
      - name: Get Run ID
        run: |
          cd Workflow-CI/MLProject
          run_id=$(cat run_id.txt)
          echo "RUN_ID=$run_id" >> $GITHUB_ENV

      # 3. Login Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. Build & Push Docker (Metode Offline)
      # Kita arahkan langsung ke folder "model_docker" yang dibuat di langkah 1
      - name: Build & Push Docker
        run: |
          cd Workflow-CI/MLProject
          
          # Lowercase nama image
          LOWER_IMAGE_NAME=$(echo "${{ env.DOCKER_IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          echo "Building Docker Image: $LOWER_IMAGE_NAME from local folder"

          # Build dari folder lokal "model_docker"
          # TIDAK ADA DOWNLOAD = TIDAK ADA ERROR 404
          mlflow models build-docker \
            -m "model_docker" \
            -n "$LOWER_IMAGE_NAME:latest"

          docker push "$LOWER_IMAGE_NAME:latest"

      # 5. Simpan Artefak ke GitHub
      - name: Commit Artifacts
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "bot@noreply.github.com"
          cd Workflow-CI/MLProject
          git add *.png
          git commit -m "Auto-save artifacts [skip ci]" || echo "No changes"
          git push